<div class="container">
  <div class="row">
    <div class="col-md-7">
      <h4 class="text-center mb-5 mt-5"><%= @event.name %></h4>
      <div class="card rounded-0 mt-5 mb-5">
        <%= image_tag "dummy-event.png", class: "card-img-top" %>
        <div class="card-body">
          <% if !registered?(@event) %>
            <button type="button" class="btn btn-primary ml-4 pl-4 pr-4" data-toggle="modal" data-target="#exampleModal">
              Register
            </button>
          <% end %>
        </div>
        <div class="card-body">

          <% img = find_favourite(@event) ? '/assets/fav.svg' : '/assets/unfav.svg' %>

          <p class="lead"><%= @event.start_date.strftime("%b %m %Y %H:%M %p") %> To <%= @event.end_date.strftime("%b %m %Y %H:%M %p") %>
            <span class="float-right"><img src=<%= img %> height="30px" width="30px" class="fav"></span>
            </p>
          <%= render "partials/lorem_description" %>
          <%= render "partials/ticket_modal" %>
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div id="map-single" class="mt-5 mb-5"></div>
      <% if @event.tags.present? %>
        <div class="card rounded-0">
          <div class="card-body">
            <p>
              <p>Find more events for following tags</p>
              <% @event.tags.each do |tag| %>
                <%= link_to tag.name.titleize, tag_path(tag: tag.name), class: "btn btn-primary btn-sm mb-2" %>
              <% end %>
            </p>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  <div id="warnings-panel"></div>
</div>

<script>
  var lat = 0, lng = 0;
  navigator.geolocation.getCurrentPosition(showPosition)

  function initMap() {
    var venue = {lat: <%= @event.latitude %>, lng: <%= @event.longitude %>};
    var map = new google.maps.Map(
      document.getElementById('map-single'),
      {zoom: 12, center: venue}
    );

    var directionsService = new google.maps.DirectionsService;
    var directionsDisplay = new google.maps.DirectionsRenderer({map: map});
    var stepDisplay = new google.maps.InfoWindow;

    var infowindow = new google.maps.InfoWindow({
      content: "<h3 style='color:#333;'><%= @event.name %></h3>" + "<p><%= @event.venue %></p>"
    });

    var userinfowindow = new google.maps.InfoWindow({
      content: "<h3 style='color:#333;'>your location</h3>"
    });
    var your_location = {lat: lat, lng: lng};
    var marker1 = new google.maps.Marker({position: venue, map: map});
    var marker2 = new google.maps.Marker({position: your_location, map: map});
    marker1.addListener('click', function() {
      infowindow.open(map, marker1);
    });

    marker2.addListener('click', function() {
      userinfowindow.open(map, marker2);
    });

    var markerArray = [marker1, marker2]

    calculateAndDisplayRoute(directionsDisplay, directionsService, markerArray, stepDisplay, map, your_location, venue);

  }

  function showPosition(position) {
    lat = position.coords.latitude;
    lng = position.coords.longitude;
  }

  function calculateAndDisplayRoute(directionsDisplay, directionsService,
      markerArray, stepDisplay, map, origin, destination) {

    for (var i = 0; i < markerArray.length; i++) {
      markerArray[i].setMap(null);
    }

    directionsService.route({
      origin: origin,
      destination: destination,
      travelMode: 'DRIVING'
    }, function(response, status) {

      if (status === 'OK') {
        document.getElementById('warnings-panel').innerHTML =
            '<b>' + response.routes[0].warnings + '</b>';
        directionsDisplay.setDirections(response);
        // showSteps(response, markerArray, stepDisplay, map);
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });
  }

  // function showSteps(directionResult, markerArray, stepDisplay, map) {
  //   var myRoute = directionResult.routes[0].legs[0];
  //   for (var i = 0; i < myRoute.steps.length; i++) {
  //     var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
  //     marker.setMap(map);
  //     marker.setPosition(myRoute.steps[i].start_location);
  //     attachInstructionText(
  //         stepDisplay, marker, myRoute.steps[i].instructions, map);
  //   }
  // }

  // function attachInstructionText(stepDisplay, marker, text, map) {
  //   google.maps.event.addListener(marker, 'click', function() {
  //     // Open an info window when the marker is clicked on, containing the text
  //     // of the step.
  //     stepDisplay.setContent(text);
  //     stepDisplay.open(map, marker);
  //   });
  // }
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.google_map_api_key %>&callback=initMap">
</script>

<script type="text/javascript">
  $(document).on('click', '.fav', function(){
  var event_id = <%= @event.id %>
  hash = {url: '/favourites', type: 'post', data: {event: event_id}, dataType: "script"};
  $.ajax(hash);
});
</script>




